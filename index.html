<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Library Viewer</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #0f0f12;
            --surface-color: #1a1a20;
            --surface-hover: #23232a;
            --primary-accent: #7c5cff;
            --secondary-accent: #ff4785;
            --text-primary: #ffffff;
            --text-secondary: #a0a0b0;
            --border-radius: 12px;
            --card-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
        }

        body {
            font-family: 'Outfit', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            margin: 0;
            padding: 0;
            min-height: 100vh;
            background-image: radial-gradient(circle at 10% 20%, rgba(124, 92, 255, 0.05) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(255, 71, 133, 0.05) 0%, transparent 20%);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        header {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 50px;
            animation: fadeInDown 0.8s ease;
            position: relative;
        }

        h1 {
            font-size: 3.5rem;
            margin: 0 0 30px 0;
            background: linear-gradient(135deg, #fff 0%, #a5a5a5 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 700;
            letter-spacing: -1px;
        }

        .controls {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(10px);
            padding: 20px 30px;
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            width: 100%;
            max-width: 900px;
            box-sizing: border-box;
        }

        .input-group {
            position: relative;
            flex-grow: 1;
            min-width: 200px;
        }

        input,
        select,
        button {
            padding: 12px 20px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background-color: rgba(30, 30, 35, 0.8);
            color: var(--text-primary);
            font-size: 1rem;
            font-family: inherit;
            transition: all 0.3s ease;
            width: 100%;
            box-sizing: border-box;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: var(--primary-accent);
            box-shadow: 0 0 0 3px rgba(124, 92, 255, 0.2);
            background-color: rgba(40, 40, 45, 1);
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        .btn-action {
            background: linear-gradient(135deg, var(--primary-accent), var(--secondary-accent));
            border: none;
            font-weight: 600;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 1px;
            padding: 12px 20px;
            color: #fff;
            border-radius: 10px;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-action:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(124, 92, 255, 0.3);
        }

        .btn-action:active {
            transform: translateY(0);
        }

        .btn-export {
            background: #2a2a30;
            border: 1px solid var(--primary-accent);
            color: var(--primary-accent);
            padding: 12px 20px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-export:hover {
            background: var(--primary-accent);
            color: #fff;
        }

        .btn-edit {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--text-secondary);
            font-size: 0.8rem;
            padding: 5px 10px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-edit:hover {
            border-color: #fff;
            color: #fff;
            background: rgba(255, 255, 255, 0.05);
        }

        .platform-icon.amazon {
            background-image: url('logos/amazon_logo.png');
        }

        .platform-icon.microsoft {
            background-image: url('logos/microsoft_logo.png');
        }

        /* Generic backup if needed */
        .platform-icon.other {
            background-color: #555;
        }

        /* Stats Bar */
        .stats-bar {
            margin-top: 15px;
            color: var(--text-secondary);
            font-size: 0.9rem;
            animation: fadeIn 1s ease 0.5s backwards;
            display: flex;
            justify-content: space-between;
            width: 90%;
            max-width: 900px;
        }

        /* Grid Layout */
        .game-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 25px;
            animation: fadeInUp 0.8s ease 0.2s backwards;
        }

        .game-card {
            background-color: var(--surface-color);
            border-radius: var(--border-radius);
            padding: 25px;
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.03);
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .game-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-accent), var(--secondary-accent));
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .game-card.played-true {
            border-color: rgba(0, 255, 170, 0.3);
        }

        /* Removed textual badge on bottom right as requested */


        .game-card:hover {
            transform: translateY(-5px);
            background-color: var(--surface-hover);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.4);
            border-color: rgba(255, 255, 255, 0.1);
        }

        .game-card:hover::before {
            opacity: 1;
        }

        /* Rating Badge */
        .rating-badge {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.8rem;
            color: #fff;
            background: #333;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            cursor: pointer;
            transition: transform 0.2s;
        }

        .rating-badge:hover {
            transform: scale(1.1);
        }

        .game-header {
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            padding-right: 40px;
            /* Space for badge */
        }

        .game-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: #fff;
            line-height: 1.3;
            margin-bottom: 5px;
            display: -webkit-box;
            background-clip: text;
            /* Standards compliant */
            -webkit-background-clip: text;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .card-meta {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .platforms-list {
            display: flex;
            gap: 8px;
        }

        .platform-tag {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .platform-Amazon {
            background: rgba(255, 153, 0, 0.2);
            color: #ffad33;
            border: 1px solid rgba(255, 153, 0, 0.3);
        }

        .platform-Epic {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .platform-GOG {
            background: rgba(137, 70, 232, 0.2);
            color: #a46bf5;
            border: 1px solid rgba(137, 70, 232, 0.3);
        }

        .genres-list {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .genre-tag {
            font-size: 0.8rem;
            color: var(--text-secondary);
            background: rgba(255, 255, 255, 0.05);
            padding: 3px 8px;
            border-radius: 4px;
        }

        .genre-tag.sconosciuto {
            color: #ff4785;
            background: rgba(255, 71, 133, 0.1);
        }

        .editable-genre-tag {
            cursor: pointer;
            transition: background 0.2s;
            position: relative;
            padding-right: 20px;
        }

        .editable-genre-tag:hover {
            background: rgba(255, 71, 133, 0.2);
            color: #ff4785;
        }

        .editable-genre-tag::after {
            content: 'Ã—';
            position: absolute;
            right: 5px;
            font-weight: bold;
        }

        .card-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: auto;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 20px;
        }

        .switch input {
            display: none;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #333;
            transition: .4s;
            border-radius: 20px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.slider {
            background-color: var(--secondary-accent);
        }

        input:checked+.slider:before {
            transform: translateX(20px);
        }

        .no-results {
            grid-column: 1 / -1;
            text-align: center;
            padding: 80px;
            color: var(--text-secondary);
            font-size: 1.5rem;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 20px;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: var(--surface-color);
            padding: 40px;
            border-radius: 20px;
            max-width: 500px;
            width: 90%;
            text-align: left;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transform: scale(0.9);
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        .modal-overlay.active .modal-content {
            transform: scale(1);
        }

        .modal-header {
            margin-bottom: 25px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 15px;
        }

        .modal-game-title {
            font-size: 2rem;
            font-weight: 800;
            margin: 0;
            background: linear-gradient(90deg, #fff, #dedede);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .modal-section {
            margin-bottom: 25px;
        }

        .modal-label {
            color: var(--text-secondary);
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
            display: block;
        }

        .modal-actions {
            margin-top: 30px;
            display: flex;
            justify-content: flex-end;
            gap: 15px;
        }

        .btn-cancel {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #fff;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
        }

        .btn-save {
            background: var(--primary-accent);
            border: none;
            color: #fff;
            padding: 10px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        /* Rating Input Styling */
        .rating-control {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 6px;
            background: #333;
            border-radius: 5px;
            outline: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #fff;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            margin-top: -7px;
            /* Align thumb */
        }

        input[type="range"]::-webkit-slider-runnable-track {
            width: 100%;
            height: 6px;
            cursor: pointer;
            background: #333;
            border-radius: 5px;
        }

        #editRatingValue {
            width: 60px;
            text-align: center;
            font-weight: bold;
        }

        #ratingLargeDisplay {
            font-size: 2rem;
            font-weight: 800;
            min-width: 80px;
            text-align: center;
            color: #555;
            /* Default for ND */
            transition: color 0.2s;
        }

        .rating-wrapper {
            display: flex;
            align-items: center;
            gap: 20px;
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 15px;
        }

        /* Animations */
        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        #loading {
            text-align: center;
            font-size: 1.5rem;
            color: var(--primary-accent);
            padding: 50px;
        }

        /* SVG Icons */
        .icon {
            width: 16px;
            height: 16px;
            fill: currentColor;
            vertical-align: middle;
        }

        /* Platform Pill (Icon + Text) */
        .platform-pill {
            display: inline-flex;
            align-items: center;
            background: rgba(255, 255, 255, 0.1);
            padding: 4px 8px;
            border-radius: 4px;
            margin-right: 6px;
            margin-bottom: 4px;
            transition: background 0.2s;
        }

        .platform-pill:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .platform-icon {
            width: 32px;
            height: 32px;
            object-fit: contain;
            margin-right: 8px;
            /* Remove fill/transition as these are images now */
        }

        .platform-name {
            font-size: 0.85rem;
            /* Slightly larger text to balance 32px icon */
            font-weight: 700;
            color: #fff;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .edit-icon-btn {
            background: transparent;
            border: none;
            color: #666;
            cursor: pointer;
            padding: 5px;
            transition: color 0.2s, transform 0.2s;
        }

        .edit-icon-btn:hover {
            color: #fff;
            transform: scale(1.1);
        }

        /* Card Layout Updates */
        .card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
        }

        .played-toggle-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Chart Styles */
        .chart-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .chart-bar-row {
            display: flex;
            align-items: center;
            font-size: 0.85rem;
            color: #ccc;
        }

        .chart-label {
            width: 100px;
            text-align: right;
            padding-right: 10px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chart-bar-track {
            flex-grow: 1;
            background: rgba(255, 255, 255, 0.05);
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }

        .chart-bar-fill {
            height: 100%;
            background: var(--primary-accent);
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .chart-value {
            width: 40px;
            padding-left: 10px;
            font-weight: bold;
            font-size: 0.8rem;
        }
    </style>
</head>

<body>
    <!-- SVG Defs -->
    <svg style="display: none;">
        <defs>
            <!-- Platform icons are now PNGs in logos/ folder. SVGs removed to avoid parsing errors. -->

            <symbol id="icon-pencil" viewBox="0 0 24 24">
                <path
                    d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z" />
            </symbol>
        </defs>
    </svg>

    <div class="container">
        <header>
            <h1>Game Library</h1>
            <div class="controls">
                <div class="input-group">
                    <input type="text" id="searchInput" placeholder="Search your collection...">
                </div>
                <select id="platformFilter" style="flex-grow: 0.5;">
                    <option value="all">All Platforms</option>
                    <option value="Steam">Steam</option>
                    <option value="Amazon">Amazon</option>
                    <option value="Epic">Epic Games</option>
                    <option value="GOG">GOG</option>
                    <option value="Microsoft">Microsoft</option>
                </select>
                <select id="genreFilter" style="flex-grow: 0.5;">
                    <option value="all">All Genres</option>
                    <!-- Generates dynamically -->
                </select>
                <select id="playedFilter" style="flex-grow: 0.5;">
                    <option value="all">All Status</option>
                    <option value="true">Played</option>
                    <option value="false">Not Played</option>
                </select>
                <button id="randomBtn" class="btn-action">
                    <span>ðŸŽ² Random</span>
                </button>
                <button id="exportBtn" class="btn-export">
                    <span>ðŸ’¾ Export JSON</span>
                </button>
            </div>
            <button id="statsBtn" class="btn-action"
                style="background: transparent; border: 1px solid rgba(255,255,255,0.2); width:100%; max-width:900px; margin-top:10px;">
                <span>ðŸ“Š Statistics</span>
            </button>
            <div id="statsBar" class="stats-bar">
                <span id="gameCount">Loading stats...</span>
                <span style="font-size: 0.8rem; opacity: 0.7;">Click "Edit" on a card to modify details. Click Export to
                    save.</span>
            </div>
        </header>

        <div id="loading">Loading library...</div>
        <div id="gameGrid" class="game-grid" style="display: none;"></div>
    </div>

    <!-- FAB Add Button -->
    <button id="addGameBtn" class="fab-btn" title="Add Game">
        <svg viewBox="0 0 24 24" fill="white" width="32" height="32">
            <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z" />
        </svg>
    </button>

    <!-- Random Game Modal -->
    <div class="modal-overlay" id="randomModal">
        <div class="modal-content" style="text-align: center;">
            <div class="modal-title-label">You should play</div>
            <div class="modal-game-title" id="randomGameTitle" style="margin-bottom: 20px;">Game Title</div>
            <div class="card-meta" style="align-items: center; margin-bottom: 20px;">
                <div class="platforms-list" id="randomPlatforms"></div>
                <div class="genres-list" id="randomGenres" style="justify-content: center;"></div>
            </div>
            <div class="modal-actions" style="justify-content: center;">
                <button class="btn-cancel" onclick="closeRandomModal()">Close</button>
                <button class="btn-action" style="min-width: auto; padding: 10px 20px; font-size: 0.9rem;"
                    onclick="pickRandomGame()">Try Another</button>
            </div>
        </div>
    </div>

    <!-- Generic Game Form Modal (Add/Edit) -->
    <div id="gameFormModal" class="modal-overlay">
        <div class="modal-content">
            <span class="close-modal" id="closeGameForm">&times;</span>
            <h2 id="gameFormTitle">Edit Game</h2>

            <div class="form-group">
                <label>Title</label>
                <input type="text" id="gameTitleInput" class="full-width">
            </div>

            <div class="form-group">
                <label>Platform</label>
                <select id="gamePlatformInput" class="full-width">
                    <option value="Steam">Steam</option>
                    <option value="Epic">Epic</option>
                    <option value="Amazon">Amazon</option>
                    <option value="GOG">GOG</option>
                    <option value="Microsoft">Microsoft</option>
                    <option value="Other">Other</option>
                </select>
            </div>

            <div class="form-group">
                <label>Rating (0-100)</label>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <input type="range" id="gameRatingSlider" min="0" max="100" value="0" style="flex-grow: 1;">
                    <input type="number" id="gameRatingValue" min="0" max="100" style="width: 60px;">
                </div>
            </div>

            <div class="form-group">
                <label>Genres (comma separated)</label>
                <input type="text" id="gameGenresInput" class="full-width" placeholder="Action, RPG, Adventure...">
            </div>

            <div class="form-group">
                <label>Notes</label>
                <textarea id="gameNotesInput" rows="4" class="full-width"></textarea>
            </div>

            <div class="form-group" style="display: flex; align-items: center; gap: 10px;">
                <label>Status:</label>
                <label class="switch">
                    <input type="checkbox" id="gamePlayedInput">
                    <span class="slider round"></span>
                </label>
                <span id="gamePlayedLabel">Not Played</span>
            </div>

            <div class="modal-actions" style="justify-content: space-between; margin-top: 20px;">
                <button id="deleteGameBtn" class="btn warning-btn" style="background: #ff4444;">Delete Game</button>
                <button id="saveGameBtn" class="btn primary-btn">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Stats Modal -->
    <div class="modal-overlay" id="statsModal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header" style="display:flex; justify-content:space-between; align-items:center;">
                <div class="modal-game-title">Library Statistics</div>
                <div class="controls" style="width: auto; padding: 5px 15px; margin:0; background:none; border:none;">
                    <select id="statsScope" style="padding: 5px 10px; width:auto; font-size:0.9rem;">
                        <option value="all">Entire Library</option>
                        <option value="filtered">Current Filter</option>
                    </select>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                <!-- Column 1 -->
                <div>
                    <div class="modal-section">
                        <label class="modal-label">Status Distribution</label>
                        <div id="statsStatusChart" class="chart-container"></div>
                    </div>
                    <div class="modal-section">
                        <label class="modal-label">Platform Distribution</label>
                        <div id="statsPlatformChart" class="chart-container"></div>
                    </div>
                </div>
                <!-- Column 2 -->
                <div>
                    <div class="modal-section">
                        <label class="modal-label">Top Genres</label>
                        <div id="statsGenreChart" class="chart-container"></div>
                    </div>
                    <div class="modal-section">
                        <label class="modal-label">Rating Overview</label>
                        <div id="statsRatingChart" class="chart-container"></div>
                    </div>
                </div>
            </div>

            <div class="modal-actions">
                <button class="btn-cancel" onclick="closeStatsModal()">Close</button>
            </div>
        </div>
    </div>



    <!-- Load data as a global variable window.gamesData -->
    <script src="merged_games.js"></script>

    <script>
        let allGames = [];
        let filteredGames = [];
        let currentGameEditing = null; // Title of game being edited

        // UI Elements
        const gameGrid = document.getElementById('gameGrid');
        const loading = document.getElementById('loading');
        const searchInput = document.getElementById('searchInput');
        const platformFilter = document.getElementById('platformFilter');
        const genreFilter = document.getElementById('genreFilter');
        const playedFilter = document.getElementById('playedFilter');
        const gameCountLabel = document.getElementById('gameCount');
        const randomBtn = document.getElementById('randomBtn');
        const exportBtn = document.getElementById('exportBtn');

        // Random Modal
        const randomModal = document.getElementById('randomModal');



        // Load Data
        function loadGames() {
            try {
                if (typeof window.gamesData === 'undefined') {
                    throw new Error('Data file (merged_games.js) not found.');
                }

                allGames = window.gamesData;
                // Ensures filteredGames has data on load
                filteredGames = [...allGames];

                // Ensure fields exist
                allGames.forEach(g => {
                    if (typeof g.played === 'undefined') g.played = false;
                    if (typeof g.notes === 'undefined') g.notes = "";
                    if (typeof g.rating === 'undefined') g.rating = null;
                });

                renderGames(allGames);
                updateStats();
                updateGenreOptions();
                loading.style.display = 'none';
                gameGrid.style.display = 'grid';
            } catch (error) {
                loading.innerHTML = `<span style="color:#ff4785">Error: ${error.message}</span>`;
                console.error(error);
            }
        }

        function updateGenreOptions() {
            genreFilter.innerHTML = '<option value="all">All Genres</option>';
            const genres = new Set();
            allGames.forEach(game => {
                game.genres.forEach(g => genres.add(g));
            });
            Array.from(genres).sort().forEach(genre => {
                const option = document.createElement('option');
                option.value = genre;
                option.textContent = genre;
                genreFilter.appendChild(option);
            });
        }

        function getRatingColor(value) {
            if (value === null || value === undefined || value === "") return "#333";
            // Gradient from Red (0) to Yellow (50) to Green (100)
            // Simple HSL: Hue 0 (Red) -> 120 (Green)
            const hue = Math.floor((value / 100) * 120);
            return `hsl(${hue}, 70%, 45%)`;
        }

        function getPlatformIcon(platform) {
            let iconSrc = '';
            const p = platform.toLowerCase();

            if (p.includes('steam')) iconSrc = 'logos/steam.png';
            else if (p.includes('epic')) iconSrc = 'logos/epic.png';
            else if (p.includes('gog')) iconSrc = 'logos/gog.png';
            else if (p.includes('amazon')) iconSrc = 'logos/amazon.png';

            // Render as Pill: Image + Text
            if (iconSrc) {
                return `
                <div class="platform-pill">
                    <img src="${iconSrc}" class="platform-icon" alt="${platform}">
                    <span class="platform-name">${platform.toUpperCase()}</span>
                </div>`;
            }
            return `<span class="badge badge-platform">${platform}</span>`;
        }

        function renderGames(games) {
            gameGrid.innerHTML = '';

            if (games.length === 0) {
                gameGrid.innerHTML = '<div class="no-results">No games found matching your filters.</div>';
                return;
            }

            const displayLimit = 200;
            const gamesToShow = games.slice(0, displayLimit);

            gamesToShow.forEach((game, index) => {
                const card = document.createElement('div');
                card.className = `game-card ${game.played ? 'played-true' : ''}`;

                // Platform Icons
                let platformsHtml = '';
                game.platforms.forEach(p => {
                    platformsHtml += getPlatformIcon(p);
                });

                // Genres
                const genresHtml = game.genres.length > 0
                    ? game.genres.slice(0, 3).map(g => `<span class="genre-tag ${g === 'Sconosciuto' ? 'sconosciuto' : ''}">${g}</span>`).join('') + (game.genres.length > 3 ? `<span class="genre-tag">+${game.genres.length - 3}</span>` : '')
                    : '<span class="genre-tag sconosciuto">Sconosciuto</span>';

                const ratingDisplay = game.rating !== null ? game.rating : "ND";
                const ratingBg = getRatingColor(game.rating);
                // Safe title for onclick (legacy, now using index)
                const safeTitle = game.title.replace(/'/g, "\\'");
                // Display Title Logic
                const displayTitle = game.custom_title || game.title;

                card.innerHTML = `
                <div class="rating-badge" style="background:${ratingBg}" onclick="openGameForm(${index})">${ratingDisplay}</div>
                
                <div class="game-header">
                    <div class="game-title" title="${displayTitle}">${displayTitle}</div>
                </div>
                
                <div class="card-meta">
                    <div style="display:flex; flex-wrap:wrap; align-items:center; margin-bottom:10px;">${platformsHtml}</div>
                    <div class="genres-list">${genresHtml}</div>
                </div>
                
                <div class="card-footer">
                     <div class="played-toggle-wrapper">
                        <label class="switch">
                            <input type="checkbox" ${game.played ? 'checked' : ''} onchange="togglePlayed('${safeTitle}', this.checked)">
                            <span class="slider"></span>
                        </label>
                        <span style="font-size:0.8rem; color:#aaa; margin-left: 8px;">Played</span>
                     </div>
                     <button class="edit-icon-btn" title="Edit Details" onclick="openGameForm(${index})">
                        <svg class="icon" style="width:20px; height:20px;"><use href="#icon-pencil"></use></svg>
                     </button>
                </div>
            `;
                gameGrid.appendChild(card);
            });

            if (games.length > displayLimit) {
                const moreLabel = document.createElement('div');
                moreLabel.style.gridColumn = "1 / -1";
                moreLabel.style.textAlign = "center";
                moreLabel.style.padding = "20px";
                moreLabel.style.color = "var(--text-secondary)";
                moreLabel.textContent = `Showing ${displayLimit} of ${games.length} games. Refine your search to see more.`;
                gameGrid.appendChild(moreLabel);
            }
        }

        // Logic Actions
        function findGame(title) {
            // Find by exact title or custom_title (though internal loops use exact title usually)
            return allGames.find(g => g.title === title || g.custom_title === title);
        }

        window.togglePlayed = function (title, checked) {
            const game = findGame(title);
            if (game) {
                game.played = checked;
                // Simple logic: if 'played' filter is active, re-filter. Else just toggle class.
                if (playedFilter.value !== 'all') {
                    filterGames();
                } else {
                    // Re-rendering entire grid is expensive but safest. 
                    // Optimally we'd toggle styling on the specific card element but we lack ID refs here.
                    // Given the limit of 200 items, re-render is fine.
                    renderGames(filteredGames);
                }
            }
        }

        // Edit Modal Logic



        // CRUD Logic
        let editingGameIndex = null;

        const fabBtn = document.getElementById('addGameBtn');
        const gameFormModal = document.getElementById('gameFormModal');
        const closeGameForm = document.getElementById('closeGameForm');
        const saveGameBtn = document.getElementById('saveGameBtn');
        const deleteGameBtn = document.getElementById('deleteGameBtn');

        const gameTitleInput = document.getElementById('gameTitleInput');
        const gamePlatformInput = document.getElementById('gamePlatformInput');
        const gameRatingSlider = document.getElementById('gameRatingSlider');
        const gameRatingValue = document.getElementById('gameRatingValue');
        const gameGenresInput = document.getElementById('gameGenresInput');
        const gameNotesInput = document.getElementById('gameNotesInput');
        const gamePlayedInput = document.getElementById('gamePlayedInput');
        const gameFormTitle = document.getElementById('gameFormTitle');

        // Open Modal
        function openGameForm(index = null) {
            editingGameIndex = index;
            // Use active class for transition
            gameFormModal.classList.add('active');

            if (index === null) {
                // ADD MODE
                gameFormTitle.textContent = "Add New Game";
                deleteGameBtn.style.display = 'none';

                // Clear fields
                gameTitleInput.value = "";
                gamePlatformInput.value = "Microsoft"; // Default
                gameRatingSlider.value = 0;
                gameRatingValue.value = "";
                gameGenresInput.value = "";
                gameNotesInput.value = "";
                gamePlayedInput.checked = false;
            } else {
                // EDIT MODE
                gameFormTitle.textContent = "Edit Game";
                deleteGameBtn.style.display = 'block';

                const game = filteredGames[index];

                gameTitleInput.value = game.custom_title || game.title;
                gamePlatformInput.value = game.platforms && game.platforms.length > 0 ? game.platforms[0] : "Other";

                const r = game.rating !== null ? game.rating : 0;
                gameRatingSlider.value = r;
                gameRatingValue.value = game.rating !== null ? r : "";

                gameGenresInput.value = game.genres ? game.genres.join(", ") : "";
                gameNotesInput.value = game.notes || "";
                gamePlayedInput.checked = game.played || false;
            }
            // updateRatingVisualsInForm(); // Not implemented yet, logic is below
        }

        function closeForm() {
            gameFormModal.classList.remove('active');
        }

        function updateRatingVisualsInForm() {
            // reused logic or keep simple
        }

        // Logic to sync slider/input
        gameRatingSlider.addEventListener('input', (e) => gameRatingValue.value = e.target.value);
        gameRatingValue.addEventListener('input', (e) => gameRatingSlider.value = e.target.value);

        // Save
        saveGameBtn.addEventListener('click', () => {
            const newGame = {
                title: gameTitleInput.value,
                platforms: [gamePlatformInput.value],
                genres: gameGenresInput.value.split(',').map(s => s.trim()).filter(s => s),
                notes: gameNotesInput.value,
                played: gamePlayedInput.checked,
                rating: gameRatingValue.value === "" ? null : parseInt(gameRatingValue.value)
            };

            if (editingGameIndex !== null) {
                // Update Existing
                // We need to find the specific object in gamesData and update it.
                // Using the reference from filteredGames is risky for replacement, but safe for field update.
                const gameRef = filteredGames[editingGameIndex];

                // Update fields
                // Rename logic: update custom_title, match title if completely new
                if (newGame.title !== gameRef.title && newGame.title !== gameRef.custom_title) {
                    gameRef.custom_title = newGame.title;
                }

                gameRef.platforms = newGame.platforms;
                gameRef.genres = newGame.genres;
                gameRef.notes = newGame.notes;
                gameRef.played = newGame.played;
                gameRef.rating = newGame.rating;

            } else {
                // Add New
                // New games just set title. custom_title can be null or same.
                gamesData.push(newGame);
            }

            closeForm();
            closeForm();
            filterGames(); // Re-filter and render
            updateGenreOptions(); // Refresh genres
        });

        // Delete
        deleteGameBtn.addEventListener('click', () => {
            if (editingGameIndex !== null && confirm("Delete this game? This cannot be undone.")) {
                const gameRef = filteredGames[editingGameIndex];

                // Soft Delete: Mark as deleted so it persists in export and script knows to ignore it
                const globalIndex = gamesData.indexOf(gameRef);
                if (globalIndex > -1) {
                    gamesData[globalIndex].deleted = true;
                }

                closeForm();
                closeForm();
                filterGames();
                updateGenreOptions();
            }
        });

        // FAB Click
        fabBtn.addEventListener('click', () => openGameForm(null));
        closeGameForm.addEventListener('click', closeForm);

        // Override the old "editBtn" click logic in renderGames to use this new modal
        // We will update renderGames to call openGameForm(index) instead of openEditModal

        // ... (previous code)


        function filterGames() {
            const searchTerm = searchInput.value.toLowerCase();
            const selectedPlatform = platformFilter.value;
            const selectedGenre = genreFilter.value;
            const selectedPlayed = playedFilter.value;

            filteredGames = allGames.filter(game => {
                const displayTitle = (game.custom_title || game.title).toLowerCase();
                const matchesSearch = displayTitle.includes(searchTerm);
                const matchesPlatform = selectedPlatform === 'all' || game.platforms.includes(selectedPlatform);
                const matchesGenre = selectedGenre === 'all' || game.genres.includes(selectedGenre);
                const matchesPlayed = selectedPlayed === 'all'
                    ? true
                    : (selectedPlayed === 'true' ? game.played : !game.played);

                return matchesSearch && matchesPlatform && matchesGenre && matchesPlayed && !game.deleted;
            });

            renderGames(filteredGames);
            updateStats();
        }

        function updateStats() {
            gameCountLabel.textContent = `${filteredGames.length} games found`;
        }

        // Modal & Random Logic
        function pickRandomGame() {
            if (filteredGames.length === 0) return;
            const randomIndex = Math.floor(Math.random() * filteredGames.length);
            const game = filteredGames[randomIndex];
            document.getElementById('randomGameTitle').textContent = game.title;
            const platformsHtml = game.platforms.map(p => `<span class="platform-tag platform-${p}">${p}</span>`).join('');
            document.getElementById('randomPlatforms').innerHTML = platformsHtml;
            const genresHtml = game.genres.length > 0 ? game.genres.map(g => `<span class="genre-tag">${g}</span>`).join('') : '';
            document.getElementById('randomGenres').innerHTML = genresHtml;
            randomModal.classList.add('active');
        }

        function closeRandomModal() {
            randomModal.classList.remove('active');
        }

        // Export Logic
        function exportData() {
            const jsonStr = JSON.stringify(allGames, null, 2);
            const blob = new Blob([jsonStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'merged_games.json';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            alert("File merged_games.json downloaded!\n\n1. Replace the file in your 'GamesList' folder.\n2. Run 'python3 normalize_games.py' to apply changes and update the viewer.");
        }

        // Event Listeners
        searchInput.addEventListener('input', filterGames);
        platformFilter.addEventListener('change', filterGames);
        genreFilter.addEventListener('change', filterGames);
        playedFilter.addEventListener('change', filterGames);
        randomBtn.addEventListener('click', pickRandomGame);
        exportBtn.addEventListener('click', exportData);

        randomModal.addEventListener('click', (e) => {
            if (e.target === randomModal) closeRandomModal();
        });



        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeRandomModal();
                closeForm();
            }
        });

        // Initial load
        loadGames();

        // --- Statistics Logic ---
        const statsModal = document.getElementById('statsModal');
        const statsBtn = document.getElementById('statsBtn');
        const statsScope = document.getElementById('statsScope');

        // Charts
        const charts = {
            status: document.getElementById('statsStatusChart'),
            platform: document.getElementById('statsPlatformChart'),
            genre: document.getElementById('statsGenreChart'),
            rating: document.getElementById('statsRatingChart')
        };

        function openStatsModal() {
            statsModal.classList.add('active');
            renderStats();
        }

        function closeStatsModal() {
            statsModal.classList.remove('active');
        }

        function calculateStats(dataSet) {
            const stats = {
                status: { 'Played': 0, 'Not Played': 0 },
                platforms: {},
                genres: {},
                ratings: { '90-100': 0, '80-89': 0, '70-79': 0, '< 70': 0, 'ND': 0 }
            };

            dataSet.forEach(game => {
                // Status
                if (game.played) stats.status['Played']++;
                else stats.status['Not Played']++;

                // Platforms
                game.platforms.forEach(p => {
                    stats.platforms[p] = (stats.platforms[p] || 0) + 1;
                });

                // Genres
                game.genres.forEach(g => {
                    stats.genres[g] = (stats.genres[g] || 0) + 1;
                });

                // Ratings
                if (game.rating === null) stats.ratings['ND']++;
                else if (game.rating >= 90) stats.ratings['90-100']++;
                else if (game.rating >= 80) stats.ratings['80-89']++;
                else if (game.rating >= 70) stats.ratings['70-79']++;
                else stats.ratings['< 70']++;
            });

            return stats;
        }

        function renderChart(container, data, total) {
            // Convert data obj to sorted array
            const sorted = Object.entries(data).sort((a, b) => b[1] - a[1]);

            container.innerHTML = sorted.map(([label, value]) => {
                const percent = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                return `
                <div class="chart-bar-row">
                    <div class="chart-label" title="${label}">${label}</div>
                    <div class="chart-bar-track">
                        <div class="chart-bar-fill" style="width: ${percent}%"></div>
                    </div>
                    <div class="chart-value">${value}</div>
                </div>`;
            }).join('');
        }

        function renderStats() {
            const useFiltered = statsScope.value === 'filtered';
            const dataSet = useFiltered ? filteredGames : allGames;
            const total = dataSet.length;

            const stats = calculateStats(dataSet);

            // Render Charts
            renderChart(charts.status, stats.status, total);

            // Platforms might overlap so total is sum of platforms count not games
            // actually total games is better context for "what % of games are on steam"
            // but let's stick to simple relative bars
            renderChart(charts.platform, stats.platforms, total);

            // Limit genres to top 10
            const topGenres = Object.entries(stats.genres)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10)
                .reduce((obj, [k, v]) => ({ ...obj, [k]: v }), {});

            renderChart(charts.genre, topGenres, total);

            renderChart(charts.rating, stats.ratings, total);
        }

        statsBtn.addEventListener('click', openStatsModal);
        statsScope.addEventListener('change', renderStats);
        statsModal.addEventListener('click', (e) => {
            if (e.target === statsModal) closeStatsModal();
        });
    </script>

</body>

</html>