<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Library Viewer</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #0f0f12;
            --surface-color: #1a1a20;
            --surface-hover: #23232a;
            --primary-accent: #7c5cff;
            --secondary-accent: #ff4785;
            --text-primary: #ffffff;
            --text-secondary: #a0a0b0;
            --border-radius: 12px;
            --card-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
        }

        body {
            font-family: 'Outfit', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            margin: 0;
            padding: 0;
            min-height: 100vh;
            background-image: radial-gradient(circle at 10% 20%, rgba(124, 92, 255, 0.05) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(255, 71, 133, 0.05) 0%, transparent 20%);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        header {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 50px;
            animation: fadeInDown 0.8s ease;
            position: relative;
        }

        h1 {
            font-size: 3.5rem;
            margin: 0 0 30px 0;
            background: linear-gradient(135deg, #fff 0%, #a5a5a5 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 700;
            letter-spacing: -1px;
        }

        .controls {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(10px);
            padding: 20px 30px;
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            width: 100%;
            max-width: 900px;
            box-sizing: border-box;
        }

        .input-group {
            position: relative;
            flex-grow: 1;
            min-width: 200px;
        }

        input,
        select,
        button {
            padding: 12px 20px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background-color: rgba(30, 30, 35, 0.8);
            color: var(--text-primary);
            font-size: 1rem;
            font-family: inherit;
            transition: all 0.3s ease;
            width: 100%;
            box-sizing: border-box;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: var(--primary-accent);
            box-shadow: 0 0 0 3px rgba(124, 92, 255, 0.2);
            background-color: rgba(40, 40, 45, 1);
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        .btn-action {
            background: linear-gradient(135deg, var(--primary-accent), var(--secondary-accent));
            border: none;
            font-weight: 600;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 1px;
            padding: 12px 20px;
            color: #fff;
            border-radius: 10px;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-action:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(124, 92, 255, 0.3);
        }

        .btn-action:active {
            transform: translateY(0);
        }

        .btn-export {
            background: #2a2a30;
            border: 1px solid var(--primary-accent);
            color: var(--primary-accent);
            padding: 12px 20px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-export:hover {
            background: var(--primary-accent);
            color: #fff;
        }

        .btn-edit {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--text-secondary);
            font-size: 0.8rem;
            padding: 5px 10px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-edit:hover {
            border-color: #fff;
            color: #fff;
            background: rgba(255, 255, 255, 0.05);
        }

        /* Stats Bar */
        .stats-bar {
            margin-top: 15px;
            color: var(--text-secondary);
            font-size: 0.9rem;
            animation: fadeIn 1s ease 0.5s backwards;
            display: flex;
            justify-content: space-between;
            width: 90%;
            max-width: 900px;
        }

        /* Grid Layout */
        .game-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 25px;
            animation: fadeInUp 0.8s ease 0.2s backwards;
        }

        .game-card {
            background-color: var(--surface-color);
            border-radius: var(--border-radius);
            padding: 25px;
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.03);
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .game-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-accent), var(--secondary-accent));
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .game-card.played-true {
            border-color: rgba(0, 255, 170, 0.3);
        }

        /* Removed textual badge on bottom right as requested */


        .game-card:hover {
            transform: translateY(-5px);
            background-color: var(--surface-hover);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.4);
            border-color: rgba(255, 255, 255, 0.1);
        }

        .game-card:hover::before {
            opacity: 1;
        }

        /* Rating Badge */
        .rating-badge {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.8rem;
            color: #fff;
            background: #333;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            cursor: pointer;
            transition: transform 0.2s;
        }

        .rating-badge:hover {
            transform: scale(1.1);
        }

        .game-header {
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            padding-right: 40px;
            /* Space for badge */
        }

        .game-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: #fff;
            line-height: 1.3;
            margin-bottom: 5px;
            display: -webkit-box;
            background-clip: text;
            /* Standards compliant */
            -webkit-background-clip: text;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .card-meta {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .platforms-list {
            display: flex;
            gap: 8px;
        }

        .platform-tag {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .platform-Amazon {
            background: rgba(255, 153, 0, 0.2);
            color: #ffad33;
            border: 1px solid rgba(255, 153, 0, 0.3);
        }

        .platform-Epic {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .platform-GOG {
            background: rgba(137, 70, 232, 0.2);
            color: #a46bf5;
            border: 1px solid rgba(137, 70, 232, 0.3);
        }

        .genres-list {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .genre-tag {
            font-size: 0.8rem;
            color: var(--text-secondary);
            background: rgba(255, 255, 255, 0.05);
            padding: 3px 8px;
            border-radius: 4px;
        }

        .genre-tag.sconosciuto {
            color: #ff4785;
            background: rgba(255, 71, 133, 0.1);
        }

        .editable-genre-tag {
            cursor: pointer;
            transition: background 0.2s;
            position: relative;
            padding-right: 20px;
        }

        .editable-genre-tag:hover {
            background: rgba(255, 71, 133, 0.2);
            color: #ff4785;
        }

        .editable-genre-tag::after {
            content: 'Ã—';
            position: absolute;
            right: 5px;
            font-weight: bold;
        }

        .card-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: auto;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 20px;
        }

        .switch input {
            display: none;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #333;
            transition: .4s;
            border-radius: 20px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.slider {
            background-color: var(--secondary-accent);
        }

        input:checked+.slider:before {
            transform: translateX(20px);
        }

        .no-results {
            grid-column: 1 / -1;
            text-align: center;
            padding: 80px;
            color: var(--text-secondary);
            font-size: 1.5rem;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 20px;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: var(--surface-color);
            padding: 40px;
            border-radius: 20px;
            max-width: 500px;
            width: 90%;
            text-align: left;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transform: scale(0.9);
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        .modal-overlay.active .modal-content {
            transform: scale(1);
        }

        .modal-header {
            margin-bottom: 25px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 15px;
        }

        .modal-game-title {
            font-size: 2rem;
            font-weight: 800;
            margin: 0;
            background: linear-gradient(90deg, #fff, #dedede);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .modal-section {
            margin-bottom: 25px;
        }

        .modal-label {
            color: var(--text-secondary);
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
            display: block;
        }

        .modal-actions {
            margin-top: 30px;
            display: flex;
            justify-content: flex-end;
            gap: 15px;
        }

        .btn-cancel {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #fff;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
        }

        .btn-save {
            background: var(--primary-accent);
            border: none;
            color: #fff;
            padding: 10px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        /* Rating Input Styling */
        .rating-control {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 6px;
            background: #333;
            border-radius: 5px;
            outline: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #fff;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            margin-top: -7px;
            /* Align thumb */
        }

        input[type="range"]::-webkit-slider-runnable-track {
            width: 100%;
            height: 6px;
            cursor: pointer;
            background: #333;
            border-radius: 5px;
        }

        #editRatingValue {
            width: 60px;
            text-align: center;
            font-weight: bold;
        }

        #ratingLargeDisplay {
            font-size: 2rem;
            font-weight: 800;
            min-width: 80px;
            text-align: center;
            color: #555;
            /* Default for ND */
            transition: color 0.2s;
        }

        .rating-wrapper {
            display: flex;
            align-items: center;
            gap: 20px;
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 15px;
        }

        /* Animations */
        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        #loading {
            text-align: center;
            font-size: 1.5rem;
            color: var(--primary-accent);
            padding: 50px;
        }

        /* SVG Icons */
        .icon {
            width: 16px;
            height: 16px;
            fill: currentColor;
            vertical-align: middle;
        }

        /* Platform Pill (Icon + Text) */
        .platform-pill {
            display: inline-flex;
            align-items: center;
            background: rgba(255, 255, 255, 0.1);
            padding: 4px 8px;
            border-radius: 4px;
            margin-right: 6px;
            margin-bottom: 4px;
            transition: background 0.2s;
        }

        .platform-pill:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .platform-icon {
            width: 16px;
            height: 16px;
            fill: #fff;
            margin-right: 6px;
        }

        .platform-name {
            font-size: 0.75rem;
            font-weight: 700;
            color: #fff;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .edit-icon-btn {
            background: transparent;
            border: none;
            color: #666;
            cursor: pointer;
            padding: 5px;
            transition: color 0.2s, transform 0.2s;
        }

        .edit-icon-btn:hover {
            color: #fff;
            transform: scale(1.1);
        }

        /* Card Layout Updates */
        .card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
        }

        .played-toggle-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
        }
    </style>
</head>

<body>
    <!-- SVG Defs -->
    <svg style="display: none;">
        <defs>
            <!-- Steam (SimpleIcons) ViewBox: 0 0 24 24 -->
            <symbol id="icon-steam" viewBox="0 0 24 24">
                <path
                    d="M11.979 0C5.678 0 .511 4.86.022 11.037l6.432 2.658c.545-.371 1.203-.59 1.912-.59.063 0 .125.004.188.006l2.861-4.142V8.91c0-2.495 2.028-4.524 4.524-4.524 2.494 0 4.524 2.031 4.524 4.527s-2.03 4.525-4.524 4.525h-.105l-4.076 2.911c0 .052.004.105.004.159 0 1.875-1.515 3.396-3.39 3.396-1.635 0" />
            </symbol>

            <!-- Epic Games (SimpleIcons) ViewBox: 0 0 24 24 -->
            <symbol id="icon-epic" viewBox="0 0 24 24">
                <path
                    d="M12 0C5.373 0 0 5.373 0 12s5.373 12 12 12 12-5.373 12-12S18.627 0 12 0zm3.435 15.908l-.515.515-6.546-6.546-3.765 3.765L12 21.015l10.32-10.32L15.435 3.81 8.41 10.745l.59.59 6.435-6.435z" />
            </symbol>

            <!-- GOG (SimpleIcons) ViewBox: 0 0 24 24 -->
            <symbol id="icon-gog" viewBox="0 0 24 24">
                <path
                    d="M16.56 0c-4.42 0-8 3.58-8 8s3.58 8 8 8 8-3.58 8-8-3.58-8-8-8zm-2.8 11.2h-1.6v-4.8h1.6v4.8zm4 0h-1.6v-4.8h1.6v4.8zm3.6 0h-1.6v-3.2h-1.2v-1.6h2.8v4.8z" />
                <!-- Note: GOG path above is simplified placeholder if precise one fails, but let's try a better one below -->
            </symbol>

            <!-- Actual SimpleIcons GOG Path (Replaced with verified) -->
            <symbol id="icon-gog-real" viewBox="0 0 24 24">
                <path
                    d="M2.583 14.502h2.245a.309.309 0 0 0 .309-.31v-1.547a.309.309 0 0 0-.309-.309h-2.14v-4.14h2.793c.47 0 .852.383.852.852v2.71c0 .47-.382.852-.852.852H2.686v1.07h2.952c.491 0 .89.398.89.89v4.54a.89.89 0 0 1-.89.889H1.328a.89.89 0 0 1-.89-.89V4.89A.89.89 0 0 1 1.328 4h3.664c.491 0 .89.398.89.89v2.553a.309.309 0 0 1-.309.309h-1.565a.309.309 0 0 1-.309-.309v-1.66H1.533v9.06h1.05zm5.786-2.923H9.98a.309.309 0 0 0 .31-.31v-1.546a.309.309 0 0 0-.31-.31H7.842v-4.14h2.793c.47 0 .852.383.852.852v2.71c0 .47-.382.852-.852.852H7.843v1.07h2.951c.492 0 .89.398.89.89v4.54a.89.89 0 0 1-.89.889H6.485a.89.89 0 0 1-.89-.89V4.89a.89.89 0 0 1 .89-.89h3.664c.491 0 .89.398.89.89v2.553a.309.309 0 0 1-.309.309H9.165a.309.309 0 0 1-.309-.309v-1.66H6.69v9.06h1.68zm13.313 7.782h-1.02v-3.18h-.72a.31.31 0 0 0-.31.31v2.87h-1.03v-3.18h-.72a.31.31 0 0 0-.309.31v2.87h-1.03v-3.41c0-.432.352-.782.793-.782h4.341v4.202zM22.713 8.91c0 .448-.363.811-.811.811h-3.465V8.68h2.924a.309.309 0 0 0 .309-.31V4.93a.309.309 0 0 0-.309-.31h-1.564a.309.309 0 0 0-.31.31v1.562a.309.309 0 0 0 .31.31h1.252V7.84H18.35c-.448 0-.811-.355-.811-.803V4.382c0-.437.363-.803.811-.803h2.648c.448 0 .811.363.811.803V8.91z" />
            </symbol>

            <!-- Amazon (SimpleIcons) ViewBox: 0 0 24 24 -->
            <symbol id="icon-amazon" viewBox="0 0 24 24">
                <path
                    d="M13.712 11.232c-3.111 0-3.52 1.944-3.52 1.944s-.096 1.487-.096 1.776c0 .96.96 1.344 1.967 1.344 1.777 0 3.841-1.296 3.841-3.648v-2.016c-1.393.192-2.193.6-2.193.6zm.432 5.064c-2.496 0-4.608-1.248-4.608-3.456 0-2.496 2.015-4.464 6.72-4.464.095 0 .191.006.287.01V7.93c0-2.064-1.248-2.688-2.928-2.688-1.632 0-2.688.48-2.688.48l-.48-2.112s1.392-.768 3.552-.768c3.024 0 4.752 1.584 4.752 4.992v5.808c0 .288.048.576.096.864.144.624.576.96.576.96l-2.689 1.152s-.287.144-.432 0c-.144.144-.144-.336-.144-.336s-1.008 1.488-3.408 1.488zm-3.09 5.097c5.176 3.592 11.218 2.052 11.218 2.052-.924-1.92-1.908-1.788-1.908-1.788-4.223 1.164-8.086-1.548-8.086-1.548l-1.224 1.284zm11.564-2.82c2.064-1.248 3.324-4.284 3.324-4.284-.486 1.584-3.235 3.192-3.235 3.192-.416.27-.406.883-.089 1.092z" />
            </symbol>

            <symbol id="icon-pencil" viewBox="0 0 24 24">
                <path
                    d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z" />
            </symbol>
        </defs>
    </svg>

    <div class="container">
        <header>
            <h1>Game Library</h1>
            <div class="controls">
                <div class="input-group">
                    <input type="text" id="searchInput" placeholder="Search your collection...">
                </div>
                <select id="platformFilter" style="flex-grow: 0.5;">
                    <option value="all">All Platforms</option>
                    <option value="Steam">Steam</option>
                    <option value="Amazon">Amazon</option>
                    <option value="Epic">Epic</option>
                    <option value="GOG">GOG</option>
                </select>
                <select id="genreFilter" style="flex-grow: 0.5;">
                    <option value="all">All Genres</option>
                    <!-- Generates dynamically -->
                </select>
                <select id="playedFilter" style="flex-grow: 0.5;">
                    <option value="all">All Status</option>
                    <option value="true">Played</option>
                    <option value="false">Not Played</option>
                </select>
                <button id="randomBtn" class="btn-action">
                    <span>ðŸŽ² Random</span>
                </button>
                <button id="exportBtn" class="btn-export">
                    <span>ðŸ’¾ Export JSON</span>
                </button>
            </div>
            <div id="statsBar" class="stats-bar">
                <span id="gameCount">Loading stats...</span>
                <span style="font-size: 0.8rem; opacity: 0.7;">Click "Edit" on a card to modify details. Click Export to
                    save.</span>
            </div>
        </header>

        <div id="loading">Loading library...</div>
        <div id="gameGrid" class="game-grid" style="display: none;"></div>
    </div>

    <!-- Random Game Modal -->
    <div class="modal-overlay" id="randomModal">
        <div class="modal-content" style="text-align: center;">
            <div class="modal-title-label">You should play</div>
            <div class="modal-game-title" id="randomGameTitle" style="margin-bottom: 20px;">Game Title</div>
            <div class="card-meta" style="align-items: center; margin-bottom: 20px;">
                <div class="platforms-list" id="randomPlatforms"></div>
                <div class="genres-list" id="randomGenres" style="justify-content: center;"></div>
            </div>
            <div class="modal-actions" style="justify-content: center;">
                <button class="btn-cancel" onclick="closeRandomModal()">Close</button>
                <button class="btn-action" style="min-width: auto; padding: 10px 20px; font-size: 0.9rem;"
                    onclick="pickRandomGame()">Try Another</button>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div class="modal-overlay" id="editModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-label">Editing</div>
                <div class="modal-game-title" id="editGameTitle">Game Title</div>
            </div>

            <div class="modal-section">
                <label class="modal-label">Rating (0-100)</label>
                <div class="rating-wrapper">
                    <div style="flex-grow: 1;">
                        <input type="range" id="editRatingSlider" min="0" max="100" value="0" style="width: 100%;">
                        <div
                            style="display: flex; justify-content: space-between; font-size: 0.7rem; color: #666; margin-top: 5px;">
                            <span>0</span><span>50</span><span>100</span>
                        </div>
                    </div>
                    <div style="display: flex; flex-direction: column; align-items: center; gap: 5px;">
                        <span id="ratingLargeDisplay">ND</span>
                        <input type="number" id="editRatingValue" min="0" max="100" placeholder="Set"
                            style="width: 50px; background: transparent; border: 1px solid #444; color: #aaa; text-align: center; font-size: 0.8rem; border-radius: 4px;">
                    </div>
                </div>
            </div>

            <div class="modal-section">
                <label class="modal-label">Genres</label>
                <div class="genres-list" id="editGenresList" style="margin-bottom:10px;"></div>
                <div style="display:flex; gap:10px;">
                    <input type="text" id="newGenreInput" placeholder="Add genre..." style="padding: 8px;">
                    <button class="btn-edit" onclick="addGenreFromModal()">Add</button>
                </div>
            </div>

            <div class="modal-section">
                <label class="modal-label">Notes</label>
                <textarea id="editNotes" placeholder="Personal notes..."></textarea>
            </div>

            <div class="modal-actions">
                <button class="btn-cancel" onclick="closeEditModal()">Cancel</button>
                <button class="btn-save" onclick="saveEditModal()">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Load data as a global variable window.gamesData -->
    <script src="merged_games.js"></script>

    <script>
        let allGames = [];
        let filteredGames = [];
        let currentGameEditing = null; // Title of game being edited

        // UI Elements
        const gameGrid = document.getElementById('gameGrid');
        const loading = document.getElementById('loading');
        const searchInput = document.getElementById('searchInput');
        const platformFilter = document.getElementById('platformFilter');
        const genreFilter = document.getElementById('genreFilter');
        const playedFilter = document.getElementById('playedFilter');
        const gameCountLabel = document.getElementById('gameCount');
        const randomBtn = document.getElementById('randomBtn');
        const exportBtn = document.getElementById('exportBtn');

        // Random Modal
        const randomModal = document.getElementById('randomModal');

        // Edit Modal
        const editModal = document.getElementById('editModal');
        const editGameTitle = document.getElementById('editGameTitle');
        const editRatingSlider = document.getElementById('editRatingSlider');
        const editRatingValue = document.getElementById('editRatingValue');
        const editGenresList = document.getElementById('editGenresList');
        const newGenreInput = document.getElementById('newGenreInput');
        const editNotes = document.getElementById('editNotes');

        // Load Data
        function loadGames() {
            try {
                if (typeof window.gamesData === 'undefined') {
                    throw new Error('Data file (merged_games.js) not found.');
                }

                allGames = window.gamesData;
                // Ensure fields exist
                allGames.forEach(g => {
                    if (typeof g.played === 'undefined') g.played = false;
                    if (typeof g.notes === 'undefined') g.notes = "";
                    if (typeof g.rating === 'undefined') g.rating = null;
                });

                renderGames(allGames);
                updateStats();
                updateGenreOptions();
                loading.style.display = 'none';
                gameGrid.style.display = 'grid';
            } catch (error) {
                loading.innerHTML = `<span style="color:#ff4785">Error: ${error.message}</span>`;
                console.error(error);
            }
        }

        function updateGenreOptions() {
            genreFilter.innerHTML = '<option value="all">All Genres</option>';
            const genres = new Set();
            allGames.forEach(game => {
                game.genres.forEach(g => genres.add(g));
            });
            Array.from(genres).sort().forEach(genre => {
                const option = document.createElement('option');
                option.value = genre;
                option.textContent = genre;
                genreFilter.appendChild(option);
            });
        }

        function getRatingColor(value) {
            if (value === null || value === undefined || value === "") return "#333";
            // Gradient from Red (0) to Yellow (50) to Green (100)
            // Simple HSL: Hue 0 (Red) -> 120 (Green)
            const hue = Math.floor((value / 100) * 120);
            return `hsl(${hue}, 70%, 45%)`;
        }

        function getPlatformIcon(platform) {
            let id = '';
            const p = platform.toLowerCase();
            if (p.includes('steam')) id = '#icon-steam';
            else if (p.includes('epic')) id = '#icon-epic';
            else if (p.includes('gog')) id = '#icon-gog-real';
            else if (p.includes('amazon')) id = '#icon-amazon';

            // Render as Pill: Icon + Text
            if (id) {
                return `
                <div class="platform-pill">
                    <svg class="platform-icon"><use href="${id}"></use></svg>
                    <span class="platform-name">${platform.toUpperCase()}</span>
                </div>`;
            }
            return `<span class="badge badge-platform">${platform}</span>`;
        }

        function renderGames(games) {
            gameGrid.innerHTML = '';

            if (games.length === 0) {
                gameGrid.innerHTML = '<div class="no-results">No games found matching your filters.</div>';
                return;
            }

            const displayLimit = 200;
            const gamesToShow = games.slice(0, displayLimit);

            gamesToShow.forEach(game => {
                const card = document.createElement('div');
                card.className = `game-card ${game.played ? 'played-true' : ''}`;

                // Platform Icons
                let platformsHtml = '';
                game.platforms.forEach(p => {
                    platformsHtml += getPlatformIcon(p);
                });

                // Genres
                const genresHtml = game.genres.length > 0
                    ? game.genres.slice(0, 3).map(g => `<span class="genre-tag ${g === 'Sconosciuto' ? 'sconosciuto' : ''}">${g}</span>`).join('') + (game.genres.length > 3 ? `<span class="genre-tag">+${game.genres.length - 3}</span>` : '')
                    : '<span class="genre-tag sconosciuto">Sconosciuto</span>';

                const ratingDisplay = game.rating !== null ? game.rating : "ND";
                const ratingBg = getRatingColor(game.rating);
                // Safe title for onclick
                const safeTitle = game.title.replace(/'/g, "\\'");

                // Layout: Rating Badge Top Right
                // Title
                // Meta: Platforms (Icons), Genres
                // Footer: Toggle (left), Edit Pencil (right)

                card.innerHTML = `
                <div class="rating-badge" style="background:${ratingBg}" onclick="openEditModal('${safeTitle}')">${ratingDisplay}</div>
                
                <div class="game-header">
                    <div class="game-title" title="${game.title}">${game.title}</div>
                </div>
                
                <div class="card-meta">
                    <div style="display:flex; flex-wrap:wrap; align-items:center; margin-bottom:10px;">${platformsHtml}</div>
                    <div class="genres-list">${genresHtml}</div>
                </div>
                
                <div class="card-footer">
                     <div class="played-toggle-wrapper">
                        <label class="switch">
                            <input type="checkbox" ${game.played ? 'checked' : ''} onchange="togglePlayed('${safeTitle}', this.checked)">
                            <span class="slider"></span>
                        </label>
                        <span style="font-size:0.8rem; color:#aaa; margin-left: 8px;">Played</span>
                     </div>
                     <button class="edit-icon-btn" title="Edit Details" onclick="openEditModal('${safeTitle}')">
                        <svg class="icon" style="width:20px; height:20px;"><use href="#icon-pencil"></use></svg>
                     </button>
                </div>
            `;
                gameGrid.appendChild(card);
            });

            if (games.length > displayLimit) {
                const moreLabel = document.createElement('div');
                moreLabel.style.gridColumn = "1 / -1";
                moreLabel.style.textAlign = "center";
                moreLabel.style.padding = "20px";
                moreLabel.style.color = "var(--text-secondary)";
                moreLabel.textContent = `Showing ${displayLimit} of ${games.length} games. Refine your search to see more.`;
                gameGrid.appendChild(moreLabel);
            }
        }

        // Logic Actions
        function findGame(title) {
            return allGames.find(g => g.title === title);
        }

        window.togglePlayed = function (title, checked) {
            const game = findGame(title);
            if (game) {
                game.played = checked;
                // Simple logic: if 'played' filter is active, re-filter. Else just toggle class.
                if (playedFilter.value !== 'all') {
                    filterGames();
                } else {
                    // Re-rendering entire grid is expensive but safest. 
                    // Optimally we'd toggle styling on the specific card element but we lack ID refs here.
                    // Given the limit of 200 items, re-render is fine.
                    renderGames(filteredGames);
                }
            }
        }

        // Edit Modal Logic

        window.openEditModal = function (gameObj) { // Changed to accept game object directly
            const game = typeof gameObj === 'string' ? findGame(gameObj) : gameObj; // Handle both title string and game object
            if (!game) return;

            currentGameEditing = game.title;
            editGameTitle.textContent = game.title;

            // Rating
            if (game.rating !== null) {
                editRatingSlider.value = game.rating;
                editRatingValue.value = game.rating;
                updateRatingVisuals(game.rating);
            } else {
                editRatingSlider.value = 0; // Default slider pos
                editRatingValue.value = ""; // Show empty/placeholder
                updateRatingVisuals(null);
            }

            // Notes
            editNotes.value = game.notes || "";

            // Genres
            renderEditGenres(game.genres);

            editModal.classList.add('active');
        }

        function renderEditGenres(genres) {
            if (!genres || genres.length === 0) {
                editGenresList.innerHTML = '<span style="color:#aaa; font-style:italic;">No genres</span>';
                return;
            }
            editGenresList.innerHTML = genres.map(g =>
                `<span class="genre-tag editable-genre-tag" onclick="removeGenreFromModal('${g}')">${g}</span>`
            ).join('');
        }

        window.removeGenreFromModal = function (genre) {
            const game = findGame(currentGameEditing);
            if (game) {
                game.genres = game.genres.filter(g => g !== genre);
                renderEditGenres(game.genres);
            }
        }

        window.addGenreFromModal = function () {
            const val = newGenreInput.value.trim();
            if (!val) return;

            const game = findGame(currentGameEditing);
            if (game) {
                // Remove Sconosciuto if present
                if (game.genres.includes("Sconosciuto")) {
                    game.genres = game.genres.filter(g => g !== "Sconosciuto");
                }
                if (!game.genres.includes(val)) {
                    game.genres.push(val);
                    game.genres.sort();
                    renderEditGenres(game.genres);
                }
                newGenreInput.value = "";
            }
        }

        window.closeEditModal = function () {
            editModal.classList.remove('active');
            currentGameEditing = null;
        }

        window.saveEditModal = function () {
            const game = findGame(currentGameEditing);
            if (game) {
                // Save Notes
                game.notes = editNotes.value;

                // Save Rating
                const rVal = editRatingValue.value;
                if (rVal === "") {
                    game.rating = null;
                } else {
                    let n = parseInt(rVal);
                    if (n < 0) n = 0;
                    if (n > 100) n = 100;
                    game.rating = n;
                }

                // Genres already modified in-place
                if (game.genres.length === 0) game.genres.push("Sconosciuto");

                // Refresh
                closeEditModal();
                updateGenreOptions(); // In case new genres added
                renderGames(filteredGames); // Refresh view
            }
        }

        // Rating Control Logic
        const ratingLargeDisplay = document.getElementById('ratingLargeDisplay');

        function updateRatingVisuals(val) {
            if (val === "" || val === null) {
                ratingLargeDisplay.textContent = "ND";
                ratingLargeDisplay.style.color = "#555";
            } else {
                ratingLargeDisplay.textContent = val;
                ratingLargeDisplay.style.color = getRatingColor(val);
            }
        }

        editRatingSlider.addEventListener('input', (e) => {
            const val = e.target.value;
            editRatingValue.value = val;
            updateRatingVisuals(val);
        });

        editRatingValue.addEventListener('input', (e) => {
            let val = e.target.value;
            if (val !== "") {
                if (val > 100) val = 100;
                if (val < 0) val = 0;
                editRatingSlider.value = val;
                updateRatingVisuals(val);
            } else {
                updateRatingVisuals(null);
            }
        });

        // Reset/Init logic in openEditModal


        function filterGames() {
            const searchTerm = searchInput.value.toLowerCase();
            const selectedPlatform = platformFilter.value;
            const selectedGenre = genreFilter.value;
            const selectedPlayed = playedFilter.value;

            filteredGames = allGames.filter(game => {
                const matchesSearch = game.title.toLowerCase().includes(searchTerm);
                const matchesPlatform = selectedPlatform === 'all' || game.platforms.includes(selectedPlatform);
                const matchesGenre = selectedGenre === 'all' || game.genres.includes(selectedGenre);
                const matchesPlayed = selectedPlayed === 'all'
                    ? true
                    : (selectedPlayed === 'true' ? game.played : !game.played);

                return matchesSearch && matchesPlatform && matchesGenre && matchesPlayed;
            });

            renderGames(filteredGames);
            updateStats();
        }

        function updateStats() {
            gameCountLabel.textContent = `${filteredGames.length} games found`;
        }

        // Modal & Random Logic
        function pickRandomGame() {
            if (filteredGames.length === 0) return;
            const randomIndex = Math.floor(Math.random() * filteredGames.length);
            const game = filteredGames[randomIndex];
            document.getElementById('randomGameTitle').textContent = game.title;
            const platformsHtml = game.platforms.map(p => `<span class="platform-tag platform-${p}">${p}</span>`).join('');
            document.getElementById('randomPlatforms').innerHTML = platformsHtml;
            const genresHtml = game.genres.length > 0 ? game.genres.map(g => `<span class="genre-tag">${g}</span>`).join('') : '';
            document.getElementById('randomGenres').innerHTML = genresHtml;
            randomModal.classList.add('active');
        }

        function closeRandomModal() {
            randomModal.classList.remove('active');
        }

        // Export Logic
        function exportData() {
            const jsonStr = JSON.stringify(allGames, null, 2);
            const blob = new Blob([jsonStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'merged_games.json';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            alert("File merged_games.json downloaded!\nPlease replace the file in your 'GamesList' folder to save changes.");
        }

        // Event Listeners
        searchInput.addEventListener('input', filterGames);
        platformFilter.addEventListener('change', filterGames);
        genreFilter.addEventListener('change', filterGames);
        playedFilter.addEventListener('change', filterGames);
        randomBtn.addEventListener('click', pickRandomGame);
        exportBtn.addEventListener('click', exportData);

        randomModal.addEventListener('click', (e) => {
            if (e.target === randomModal) closeRandomModal();
        });

        editModal.addEventListener('click', (e) => {
            if (e.target === editModal) closeEditModal();
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeRandomModal();
                closeEditModal();
            }
        });

        // Initial load
        loadGames();
    </script>

</body>

</html>